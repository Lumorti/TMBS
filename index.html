<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="description" content="Figure out where that weird number is from">
<meta name="author" content="Lumorti">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>TMBS</title>
<style>
	body {margin: 0; padding: 0; overflow: hidden;}
	#view {background-color: #ffffff; position: absolute; height: 100vh; width: 100%;}
	*:focus {outline: none;}
</style>
<script>

	// Combinations with repeats https://stackoverflow.com/questions/32543936/combination-with-repetition
	function combRep(arr, l) {
	  if(l === void 0) l = arr.length; // Length of the combinations
	  var data = Array(l),             // Used to store state
		  results = [];                // Array of results
	  (function f(pos, start) {        // Recursive function
		if(pos === l) {                // End reached
		  results.push(data.slice());  // Add a copy of data to results
		  return;
		}
		for(var i=start; i<arr.length; ++i) {
		  data[pos] = arr[i];          // Update data
		  f(pos+1, i);                 // Call f recursively
		}
	  })(0, 0);                        // Start at index 0
	  return results;                  // Return results
	}

	// Is this var a float
	function isFloat(val) {
	  val = parseFloat(val);
	  return !isNaN(val);
	}

	// Searching for the lowest error
	var bestString = "";
	var bestError = 100000;
	var bestRes = 0;

	// Function called when the main button is pressed
	function run(){

		// Get various DOM elements
		var button = document.getElementById("buttonGo");
		divFormula = document.getElementById("formula");
		divError = document.getElementById("error");
		divProgress = document.getElementById("progress");

		// Stop the button whilst it's running
		button.enabled = false;

		// How many vars to get
		var numVarsMax = 5;
		var numVars = 0;
		
		// Attempts
		var maxIters = parseFloat(document.getElementById("inputIters").value);
		var maxOpsPer = parseFloat(document.getElementById("inputOper").value);
		var thresh = 1e-6;

		// Get the ideal
		var ideal = parseFloat(document.getElementById("inputMainVal").value);

		// Get the names and values
		var names = ["1"];
		var vals = [1];
		for (var i=1; i<numVarsMax+1; i++){
			var name = document.getElementById("inputName" + i).value;
			var val = document.getElementById("inputVal" + i).value;
			if (val.length > 0){
				vals.push(parseFloat(val));
				if (name.length > 0){
					names.push(name);
				} else {
					names.push(val);
				}
			}
		}

		// The operators available
		var ops = ["+", "-", "/", "*"];

		// Set these vars
		for (var i=0; i<names.length; i++){
			if (!isFloat(names[i])){
				var toRun = "var " + names[i] + " = " + vals[i] + ";";
				eval(toRun);
			}
		}
		
		// Start with fewer operations
		for (var opsPer=1; opsPer<maxOpsPer+1; opsPer++){

			// Keep trying
			for (var iter=0; iter<maxIters*opsPer; iter++){

				if (bestError < thresh){
					break;
				}

				divProgress.innerHTML = "trying " + opsPer + " operations, iteration " + iter;

				// Generate a random expression
				var expr = ["E"];
				for (var i=0; i<opsPer; i++){

					// Pick a random operator
					var op = ops[Math.floor(Math.random() * ops.length)];

					// Pick a random location to apply it
					var r = 1+Math.floor(Math.random() * expr.length);
					var loc = 0;
					while (r > 0){
						if (expr[loc] == "E"){
							r -= 1;
							if (r == 0){
								break;
							}
						}
						loc += 1;
						if (loc > expr.length){
							loc = 0;
						}
					}

					// Apply this operator
					expr.splice(loc, 0, "(");
					expr.splice(loc+2, 0, op);
					expr.splice(loc+3, 0, "E");
					expr.splice(loc+4, 0, ")");

				}

				// Loop over variable permutations
				var perms = combRep(names, opsPer+1);
				for (var j=0; j<perms.length; j++){

					// Create the eval string
					var evalString = "";
					for (var k=0; k<expr.length; k++){
						if (expr[k] == "E"){
							evalString += perms[j].pop();
						} else {
							evalString += expr[k];
						}
					}

					var res = eval(evalString);
					var error = Math.abs(res - ideal);
					if (error < bestError){
						bestError = error;
						bestRes = res;
						bestString = evalString;
					}

				}

			}

		}

		// Output the best
	    divFormula.innerHTML = "Best guess: " + bestString;
	    divError.innerHTML = "with value: " + bestRes + " (difference of " + bestError + ")";

		// Allow the button again
		button.enabled = true;

	}

</script>
</head>
<body>
	<h1 id="title">This Must Be Something</h1>
	<div id="form">
		<label for="mainVal">The value you want to simplify:</label>
		<input type="text" id="inputMainVal" name="mainVal" value="0.1667"><br>
		<label for="name1">The variables you want to use and their values (or just values):</label><br>
		<input type="text" id="inputName1" name="name1" value="d">
		<input type="text" id="inputVal1" name="val1" value="6"><br>
		<input type="text" id="inputName2" name="name2">
		<input type="text" id="inputVal2" name="val2"><br>
		<input type="text" id="inputName3" name="name3">
		<input type="text" id="inputVal3" name="val3"><br>
		<input type="text" id="inputName4" name="name4">
		<input type="text" id="inputVal4" name="val4"><br>
		<input type="text" id="inputName5" name="name5">
		<input type="text" id="inputVal5" name="val5"><br>
		<label for="oper">Max operations:</label>
		<input type="text" id="inputOper" name="oper" value="5"><br>
		<label for="iters">Max iterations:</label>
		<input type="text" id="inputIters" name="iters" value="100"><br>
		<button id="buttonGo" onclick="run()">Go</button>
	</div>
	<div id="output">
		<div id="progress">
		</div>
		<div id="formula">
		</div>
		<div id="error">
		</div>
	</div>
</body>
</html>
